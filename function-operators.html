<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 11 Function operators | Advanced R Exercises</title>
<meta name="author" content="Indrajeet Patil">
<meta name="description" content="Attaching the needed libraries: library(purrr, warn.conflicts = FALSE)  11.1 Existing function operators (Exercises 11.2.3) Q1. Base R provides a function operator in the form of Vectorize(). What...">
<meta name="generator" content="bookdown 0.40 with bs4_book()">
<meta property="og:title" content="Chapter 11 Function operators | Advanced R Exercises">
<meta property="og:type" content="book">
<meta property="og:url" content="https://bookdown.org/IndrajeetPatil/Advanced-R-exercises/function-operators.html">
<meta property="og:image" content="https://bookdown.org/IndrajeetPatil/Advanced-R-exercises/cover.png">
<meta property="og:description" content="Attaching the needed libraries: library(purrr, warn.conflicts = FALSE)  11.1 Existing function operators (Exercises 11.2.3) Q1. Base R provides a function operator in the form of Vectorize(). What...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 11 Function operators | Advanced R Exercises">
<meta name="twitter:description" content="Attaching the needed libraries: library(purrr, warn.conflicts = FALSE)  11.1 Existing function operators (Exercises 11.2.3) Q1. Base R provides a function operator in the form of Vectorize(). What...">
<meta name="twitter:image" content="https://bookdown.org/IndrajeetPatil/Advanced-R-exercises/cover.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><link href="libs/Roboto-0.4.9/font.css" rel="stylesheet">
<link href="libs/JetBrains_Mono-0.4.9/font.css" rel="stylesheet">
<link href="libs/Roboto_Slab-0.4.9/font.css" rel="stylesheet">
<script src="libs/bs3compat-0.8.0/transition.js"></script><script src="libs/bs3compat-0.8.0/tabs.js"></script><script src="libs/bs3compat-0.8.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="bs4_style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Advanced R Exercises</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">About</a></li>
<li><a class="" href="introduction.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="names-and-values.html"><span class="header-section-number">2</span> Names and values</a></li>
<li><a class="" href="vectors.html"><span class="header-section-number">3</span> Vectors</a></li>
<li><a class="" href="subsetting.html"><span class="header-section-number">4</span> Subsetting</a></li>
<li><a class="" href="control-flow.html"><span class="header-section-number">5</span> Control flow</a></li>
<li><a class="" href="functions.html"><span class="header-section-number">6</span> Functions</a></li>
<li><a class="" href="environments.html"><span class="header-section-number">7</span> Environments</a></li>
<li><a class="" href="conditions.html"><span class="header-section-number">8</span> Conditions</a></li>
<li><a class="" href="functionals.html"><span class="header-section-number">9</span> Functionals</a></li>
<li><a class="" href="function-factories.html"><span class="header-section-number">10</span> Function factories</a></li>
<li><a class="active" href="function-operators.html"><span class="header-section-number">11</span> Function operators</a></li>
<li><a class="" href="base-types.html"><span class="header-section-number">12</span> Base Types</a></li>
<li><a class="" href="s3.html"><span class="header-section-number">13</span> S3</a></li>
<li><a class="" href="r6.html"><span class="header-section-number">14</span> R6</a></li>
<li><a class="" href="s4.html"><span class="header-section-number">15</span> S4</a></li>
<li><a class="" href="trade-offs.html"><span class="header-section-number">16</span> Trade-offs</a></li>
<li><a class="" href="big-picture.html"><span class="header-section-number">17</span> Big Picture</a></li>
<li><a class="" href="expressions.html"><span class="header-section-number">18</span> Expressions</a></li>
<li><a class="" href="quasiquotation.html"><span class="header-section-number">19</span> Quasiquotation</a></li>
<li><a class="" href="evaluation.html"><span class="header-section-number">20</span> Evaluation</a></li>
<li><a class="" href="translation.html"><span class="header-section-number">21</span> Translation</a></li>
<li><a class="" href="debugging.html"><span class="header-section-number">22</span> Debugging</a></li>
<li><a class="" href="measuring-performance.html"><span class="header-section-number">23</span> Measuring performance</a></li>
<li><a class="" href="improving-performance.html"><span class="header-section-number">24</span> Improving performance</a></li>
<li><a class="" href="rewriting-r-code-in-c.html"><span class="header-section-number">25</span> Rewriting R code in C++</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/IndrajeetPatil/Advanced-R-exercises">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="function-operators" class="section level1" number="11">
<h1>
<span class="header-section-number">11</span> Function operators<a class="anchor" aria-label="anchor" href="#function-operators"><i class="fas fa-link"></i></a>
</h1>
<p>Attaching the needed libraries:</p>
<div class="sourceCode" id="cb333"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/">purrr</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<div id="existing-function-operators-exercises-11.2.3" class="section level2" number="11.1">
<h2>
<span class="header-section-number">11.1</span> Existing function operators (Exercises 11.2.3)<a class="anchor" aria-label="anchor" href="#existing-function-operators-exercises-11.2.3"><i class="fas fa-link"></i></a>
</h2>
<hr>
<p><strong>Q1.</strong> Base R provides a function operator in the form of <code><a href="https://rdrr.io/r/base/Vectorize.html">Vectorize()</a></code>. What does it do? When might you use it?</p>
<p><strong>A1.</strong> <code><a href="https://rdrr.io/r/base/Vectorize.html">Vectorize()</a></code> function creates a function that vectorizes the action of the provided function over specified arguments (i.e., it acts on each element of the vector). We will see its utility by solving a problem that otherwise would be difficult to solve.</p>
<p>The problem is to find indices of matching numeric values for the given threshold by creating a hybrid of the following functions:</p>
<ul>
<li>
<code>%in%</code> (which doesn’t provide any way to provide tolerance when comparing numeric values),</li>
<li>
<code><a href="https://dplyr.tidyverse.org/reference/near.html">dplyr::near()</a></code> (which is vectorized element-wise and thus expects two vectors of equal length)</li>
</ul>
<div class="sourceCode" id="cb334"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">which_near</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">tolerance</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Vectorize `dplyr::near()` function only over the `y` argument.</span></span>
<span>  <span class="co"># `Vectorize()` is a function operator and will return a function.</span></span>
<span>  <span class="va">customNear</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Vectorize.html">Vectorize</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="va"><a href="https://dplyr.tidyverse.org/reference/near.html">near</a></span>, vectorize.args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"y"</span><span class="op">)</span>, SIMPLIFY <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Apply the vectorized function to vector arguments and then check where the</span></span>
<span>  <span class="co"># comparisons are equal (i.e. `TRUE`) using `which()`.</span></span>
<span>  <span class="co">#</span></span>
<span>  <span class="co"># Use `compact()` to remove empty elements from the resulting list.</span></span>
<span>  <span class="va">index_list</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/keep.html">compact</a></span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="fu">customNear</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, tol <span class="op">=</span> <span class="va">tolerance</span><span class="op">)</span>, <span class="va">which</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># If there are any matches, return the indices as an atomic vector of integers.</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">index_list</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0L</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">index_vector</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/as_vector.html">simplify</a></span><span class="op">(</span><span class="va">index_list</span>, <span class="st">"integer"</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">index_vector</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># If there are no matches</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html">integer</a></span><span class="op">(</span><span class="fl">0L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Let’s use it:</p>
<div class="sourceCode" id="cb335"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.1</span>, <span class="fl">3.3</span>, <span class="fl">8.45</span>, <span class="fl">8</span>, <span class="fl">6</span><span class="op">)</span></span>
<span><span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">8.40</span>, <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">which_near</span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span>, tolerance <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 5 3</span></span></code></pre></div>
<p>Note that we needed to create a new function for this because neither of the existing functions do what we want.</p>
<div class="sourceCode" id="cb336"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">x1</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">x2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 5</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/near.html">near</a></span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span>, tol <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in x - y: longer object length is not a multiple of</span></span>
<span><span class="co">#&gt; shorter object length</span></span>
<span><span class="co">#&gt; integer(0)</span></span></code></pre></div>
<p>We solved a complex task here using the <code><a href="https://rdrr.io/r/base/Vectorize.html">Vectorize()</a></code> function!</p>
<hr>
<p><strong>Q2.</strong> Read the source code for <code><a href="https://purrr.tidyverse.org/reference/possibly.html">possibly()</a></code>. How does it work?</p>
<p><strong>A2.</strong> Let’s have a look at the source code for this function:</p>
<div class="sourceCode" id="cb337"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">possibly</span></span>
<span><span class="co">#&gt; function (.f, otherwise = NULL, quiet = TRUE) </span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;     .f &lt;- as_mapper(.f)</span></span>
<span><span class="co">#&gt;     force(otherwise)</span></span>
<span><span class="co">#&gt;     check_bool(quiet)</span></span>
<span><span class="co">#&gt;     function(...) {</span></span>
<span><span class="co">#&gt;         tryCatch(.f(...), error = function(e) {</span></span>
<span><span class="co">#&gt;             if (!quiet) </span></span>
<span><span class="co">#&gt;                 message("Error: ", conditionMessage(e))</span></span>
<span><span class="co">#&gt;             otherwise</span></span>
<span><span class="co">#&gt;         })</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; &lt;bytecode: 0x55f669b40268&gt;</span></span>
<span><span class="co">#&gt; &lt;environment: namespace:purrr&gt;</span></span></code></pre></div>
<p>Looking at this code, we can see that <code><a href="https://purrr.tidyverse.org/reference/possibly.html">possibly()</a></code>:</p>
<ul>
<li>uses <code><a href="https://rdrr.io/r/base/conditions.html">tryCatch()</a></code> for error handling</li>
<li>has a parameter <code>otherwise</code> to specify default value in case an error occurs</li>
<li>has a parameter <code>quiet</code> to suppress error message (if needed)</li>
</ul>
<hr>
<p><strong>Q3.</strong> Read the source code for <code><a href="https://purrr.tidyverse.org/reference/safely.html">safely()</a></code>. How does it work?</p>
<p><strong>A3.</strong> Let’s have a look at the source code for this function:</p>
<div class="sourceCode" id="cb338"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">safely</span></span>
<span><span class="co">#&gt; function (.f, otherwise = NULL, quiet = TRUE) </span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;     .f &lt;- as_mapper(.f)</span></span>
<span><span class="co">#&gt;     force(otherwise)</span></span>
<span><span class="co">#&gt;     check_bool(quiet)</span></span>
<span><span class="co">#&gt;     function(...) capture_error(.f(...), otherwise, quiet)</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; &lt;bytecode: 0x55f666738698&gt;</span></span>
<span><span class="co">#&gt; &lt;environment: namespace:purrr&gt;</span></span>
<span></span>
<span><span class="fu">purrr</span><span class="fu">:::</span><span class="va">capture_error</span></span>
<span><span class="co">#&gt; function (code, otherwise = NULL, quiet = TRUE) </span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;     tryCatch(list(result = code, error = NULL), error = function(e) {</span></span>
<span><span class="co">#&gt;         if (!quiet) </span></span>
<span><span class="co">#&gt;             message("Error: ", conditionMessage(e))</span></span>
<span><span class="co">#&gt;         list(result = otherwise, error = e)</span></span>
<span><span class="co">#&gt;     })</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; &lt;bytecode: 0x55f6666756c8&gt;</span></span>
<span><span class="co">#&gt; &lt;environment: namespace:purrr&gt;</span></span></code></pre></div>
<p>Looking at this code, we can see that <code><a href="https://purrr.tidyverse.org/reference/safely.html">safely()</a></code>:</p>
<ul>
<li>uses a list to save both the results (if the function executes successfully) and the error (if it fails)</li>
<li>uses <code><a href="https://rdrr.io/r/base/conditions.html">tryCatch()</a></code> for error handling</li>
<li>has a parameter <code>otherwise</code> to specify default value in case an error occurs</li>
<li>has a parameter <code>quiet</code> to suppress error message (if needed)</li>
</ul>
<hr>
</div>
<div id="case-study-creating-your-own-function-operators-exercises-11.3.1" class="section level2" number="11.2">
<h2>
<span class="header-section-number">11.2</span> Case study: Creating your own function operators (Exercises 11.3.1)<a class="anchor" aria-label="anchor" href="#case-study-creating-your-own-function-operators-exercises-11.3.1"><i class="fas fa-link"></i></a>
</h2>
<hr>
<p><strong>Q1.</strong> Weigh the pros and cons of <code>download.file %&gt;% dot_every(10) %&gt;% delay_by(0.1)</code> versus <code>download.file %&gt;% delay_by(0.1) %&gt;% dot_every(10)</code>.</p>
<p><strong>A1.</strong> Although both of these chains of piped operations produce the same number of dots and would need the same amount of time, there is a subtle difference in how they do this.</p>
<ul>
<li><code>download.file %&gt;% dot_every(10) %&gt;% delay_by(0.1)</code></li>
</ul>
<p>Here, the printing of the dot is also delayed, and the first dot is printed when the 10th URL download starts.</p>
<ul>
<li><code>download.file %&gt;% delay_by(0.1) %&gt;% dot_every(10)</code></li>
</ul>
<p>Here, the first dot is printed after the 9th download is finished, and the 10th download starts after a short delay.</p>
<hr>
<p><strong>Q2.</strong> Should you memoise <code><a href="https://rdrr.io/r/utils/download.file.html">download.file()</a></code>? Why or why not?</p>
<p><strong>A2.</strong> Since <code><a href="https://rdrr.io/r/utils/download.file.html">download.file()</a></code> is meant to download files from the Internet, memoising it is not recommended for the following reasons:</p>
<ul>
<li><p>Memoization is helpful when giving the same input the function returns the same output. This is not necessarily the case for webpages since they constantly change, and you may continue to “download” an outdated version of the webpage.</p></li>
<li><p>Memoization works by caching results, which can take up a significant amount of memory.</p></li>
</ul>
<hr>
<p><strong>Q3.</strong> Create a function operator that reports whenever a file is created or deleted in the working directory, using <code><a href="https://rdrr.io/r/base/list.files.html">dir()</a></code> and <code><a href="https://generics.r-lib.org/reference/setops.html">setdiff()</a></code>. What other global function effects might you want to track?</p>
<p><strong>A3.</strong> First, let’s create helper functions to compare and print added or removed filenames:</p>
<div class="sourceCode" id="cb339"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">print_multiple_entries</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">header</span>, <span class="va">entries</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">header</span>, <span class="st">":\n"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">entries</span>, collapse <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">file_comparator</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">old</span>, <span class="va">new</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://generics.r-lib.org/reference/setops.html">setequal</a></span><span class="op">(</span><span class="va">old</span>, <span class="va">new</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">removed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html">setdiff</a></span><span class="op">(</span><span class="va">old</span>, <span class="va">new</span><span class="op">)</span></span>
<span>  <span class="va">added</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html">setdiff</a></span><span class="op">(</span><span class="va">new</span>, <span class="va">old</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">removed</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0L</span><span class="op">)</span> <span class="fu">print_multiple_entries</span><span class="op">(</span><span class="st">"- File removed"</span>, <span class="va">removed</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">added</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0L</span><span class="op">)</span> <span class="fu">print_multiple_entries</span><span class="op">(</span><span class="st">"- File added"</span>, <span class="va">added</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We can then write a function operator and use it to create functions that will do the necessary tracking:</p>
<div class="sourceCode" id="cb340"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dir_tracker</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">f</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/force.html">force</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">old_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">dir</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html">on.exit</a></span><span class="op">(</span><span class="fu">file_comparator</span><span class="op">(</span><span class="va">old_files</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">dir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu">f</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">file_creation_tracker</span> <span class="op">&lt;-</span> <span class="fu">dir_tracker</span><span class="op">(</span><span class="va">file.create</span><span class="op">)</span></span>
<span><span class="va">file_deletion_tracker</span> <span class="op">&lt;-</span> <span class="fu">dir_tracker</span><span class="op">(</span><span class="va">file.remove</span><span class="op">)</span></span></code></pre></div>
<p>Let’s try it out:</p>
<div class="sourceCode" id="cb341"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">file_creation_tracker</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a.txt"</span>, <span class="st">"b.txt"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; - File added:</span></span>
<span><span class="co">#&gt; a.txt</span></span>
<span><span class="co">#&gt; b.txt</span></span>
<span><span class="co">#&gt; [1] TRUE TRUE</span></span>
<span></span>
<span><span class="fu">file_deletion_tracker</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a.txt"</span>, <span class="st">"b.txt"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; - File removed:</span></span>
<span><span class="co">#&gt; a.txt</span></span>
<span><span class="co">#&gt; b.txt</span></span>
<span><span class="co">#&gt; [1] TRUE TRUE</span></span></code></pre></div>
<p>Other global function effects we might want to track:</p>
<ul>
<li>working directory</li>
<li>environment variables</li>
<li>connections</li>
<li>library paths</li>
<li>graphics devices</li>
<li><a href="https://withr.r-lib.org/reference/index.html">etc.</a></li>
</ul>
<hr>
<p><strong>Q4.</strong> Write a function operator that logs a timestamp and message to a file every time a function is run.</p>
<p><strong>A4.</strong> The following function operator logs a timestamp and message to a file every time a function is run:</p>
<div class="sourceCode" id="cb342"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># helper function to write to a file connection</span></span>
<span><span class="va">write_line</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">filepath</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="va">...</span>, <span class="st">"\n"</span>, sep <span class="op">=</span> <span class="st">""</span>, file <span class="op">=</span> <span class="va">filepath</span>, append <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># function operator</span></span>
<span><span class="va">logger</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">f</span>, <span class="va">filepath</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/force.html">force</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/force.html">force</a></span><span class="op">(</span><span class="va">filepath</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">write_line</span><span class="op">(</span><span class="va">filepath</span>, <span class="st">"Function created at: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">write_line</span><span class="op">(</span><span class="va">filepath</span>, <span class="st">"Function called at:  "</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu">f</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># check that the function works as expected with a tempfile</span></span>
<span><span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_tempfile.html">with_tempfile</a></span><span class="op">(</span><span class="st">"logfile"</span>, code <span class="op">=</span> <span class="op">{</span></span>
<span>  <span class="va">logged_runif</span> <span class="op">&lt;-</span> <span class="fu">logger</span><span class="op">(</span><span class="va">runif</span>, <span class="va">logfile</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">logged_runif</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">logged_runif</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">logged_runif</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span><span class="op">(</span><span class="va">logfile</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; Function created at: 2024-08-04 00:51:27.105038</span></span>
<span><span class="co">#&gt; Function called at:  2024-08-04 00:51:32.111928</span></span>
<span><span class="co">#&gt; Function called at:  2024-08-04 00:51:37.117318</span></span>
<span><span class="co">#&gt; Function called at:  2024-08-04 00:51:45.125824</span></span></code></pre></div>
<hr>
<p><strong>Q5.</strong> Modify <code>delay_by()</code> so that instead of delaying by a fixed amount of time, it ensures that a certain amount of time has elapsed since the function was last called. That is, if you called <code>g &lt;- delay_by(1, f); g(); Sys.sleep(2); g()</code> there shouldn’t be an extra delay.</p>
<p><strong>A5.</strong> Modified version of the function meeting the specified requirements:</p>
<div class="sourceCode" id="cb343"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">delay_by_atleast</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">f</span>, <span class="va">amount</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/force.html">force</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/force.html">force</a></span><span class="op">(</span><span class="va">amount</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># the last time the function was run</span></span>
<span>  <span class="va">last_time</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">last_time</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">wait</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">last_time</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="va">amount</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">wait</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="va">wait</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># update the time in the parent frame for the next run when the function finishes</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html">on.exit</a></span><span class="op">(</span><span class="va">last_time</span> <span class="op">&lt;&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu">f</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<hr>
</div>
<div id="session-information-9" class="section level2" number="11.3">
<h2>
<span class="header-section-number">11.3</span> Session information<a class="anchor" aria-label="anchor" href="#session-information-9"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb344"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">sessioninfo</span><span class="fu">::</span><span class="fu"><a href="https://r-lib.github.io/sessioninfo/reference/session_info.html">session_info</a></span><span class="op">(</span>include_base <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; ─ Session info ───────────────────────────────────────────</span></span>
<span><span class="co">#&gt;  setting  value</span></span>
<span><span class="co">#&gt;  version  R version 4.4.1 (2024-06-14)</span></span>
<span><span class="co">#&gt;  os       Ubuntu 22.04.4 LTS</span></span>
<span><span class="co">#&gt;  system   x86_64, linux-gnu</span></span>
<span><span class="co">#&gt;  ui       X11</span></span>
<span><span class="co">#&gt;  language (EN)</span></span>
<span><span class="co">#&gt;  collate  C.UTF-8</span></span>
<span><span class="co">#&gt;  ctype    C.UTF-8</span></span>
<span><span class="co">#&gt;  tz       UTC</span></span>
<span><span class="co">#&gt;  date     2024-08-04</span></span>
<span><span class="co">#&gt;  pandoc   3.3 @ /opt/hostedtoolcache/pandoc/3.3/x64/ (via rmarkdown)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ─ Packages ───────────────────────────────────────────────</span></span>
<span><span class="co">#&gt;  package     * version date (UTC) lib source</span></span>
<span><span class="co">#&gt;  base        * 4.4.1   2024-08-02 [3] local</span></span>
<span><span class="co">#&gt;  bookdown      0.40    2024-07-02 [1] RSPM</span></span>
<span><span class="co">#&gt;  bslib         0.8.0   2024-07-29 [1] RSPM</span></span>
<span><span class="co">#&gt;  cachem        1.1.0   2024-05-16 [1] RSPM</span></span>
<span><span class="co">#&gt;  cli           3.6.3   2024-06-21 [1] RSPM</span></span>
<span><span class="co">#&gt;  compiler      4.4.1   2024-08-01 [3] local</span></span>
<span><span class="co">#&gt;  datasets    * 4.4.1   2024-08-02 [3] local</span></span>
<span><span class="co">#&gt;  digest        0.6.36  2024-06-23 [1] RSPM</span></span>
<span><span class="co">#&gt;  downlit       0.4.4   2024-06-10 [1] RSPM</span></span>
<span><span class="co">#&gt;  dplyr         1.1.4   2023-11-17 [1] RSPM</span></span>
<span><span class="co">#&gt;  evaluate      0.24.0  2024-06-10 [1] RSPM</span></span>
<span><span class="co">#&gt;  fansi         1.0.6   2023-12-08 [1] RSPM</span></span>
<span><span class="co">#&gt;  fastmap       1.2.0   2024-05-15 [1] RSPM</span></span>
<span><span class="co">#&gt;  fs            1.6.4   2024-04-25 [1] RSPM</span></span>
<span><span class="co">#&gt;  generics      0.1.3   2022-07-05 [1] RSPM</span></span>
<span><span class="co">#&gt;  glue          1.7.0   2024-01-09 [1] RSPM</span></span>
<span><span class="co">#&gt;  graphics    * 4.4.1   2024-08-02 [3] local</span></span>
<span><span class="co">#&gt;  grDevices   * 4.4.1   2024-08-02 [3] local</span></span>
<span><span class="co">#&gt;  htmltools     0.5.8.1 2024-04-04 [1] RSPM</span></span>
<span><span class="co">#&gt;  jquerylib     0.1.4   2021-04-26 [1] RSPM</span></span>
<span><span class="co">#&gt;  jsonlite      1.8.8   2023-12-04 [1] RSPM</span></span>
<span><span class="co">#&gt;  knitr         1.48    2024-07-07 [1] RSPM</span></span>
<span><span class="co">#&gt;  lifecycle     1.0.4   2023-11-07 [1] RSPM</span></span>
<span><span class="co">#&gt;  magrittr    * 2.0.3   2022-03-30 [1] RSPM</span></span>
<span><span class="co">#&gt;  memoise       2.0.1   2021-11-26 [1] RSPM</span></span>
<span><span class="co">#&gt;  methods     * 4.4.1   2024-08-02 [3] local</span></span>
<span><span class="co">#&gt;  pillar        1.9.0   2023-03-22 [1] RSPM</span></span>
<span><span class="co">#&gt;  pkgconfig     2.0.3   2019-09-22 [1] RSPM</span></span>
<span><span class="co">#&gt;  purrr       * 1.0.2   2023-08-10 [1] RSPM</span></span>
<span><span class="co">#&gt;  R6            2.5.1   2021-08-19 [1] RSPM</span></span>
<span><span class="co">#&gt;  rlang         1.1.4   2024-06-04 [1] RSPM</span></span>
<span><span class="co">#&gt;  rmarkdown     2.27    2024-05-17 [1] RSPM</span></span>
<span><span class="co">#&gt;  sass          0.4.9   2024-03-15 [1] RSPM</span></span>
<span><span class="co">#&gt;  sessioninfo   1.2.2   2021-12-06 [1] RSPM</span></span>
<span><span class="co">#&gt;  stats       * 4.4.1   2024-08-02 [3] local</span></span>
<span><span class="co">#&gt;  tibble        3.2.1   2023-03-20 [1] RSPM</span></span>
<span><span class="co">#&gt;  tidyselect    1.2.1   2024-03-11 [1] RSPM</span></span>
<span><span class="co">#&gt;  tools         4.4.1   2024-08-01 [3] local</span></span>
<span><span class="co">#&gt;  utf8          1.2.4   2023-10-22 [1] RSPM</span></span>
<span><span class="co">#&gt;  utils       * 4.4.1   2024-08-02 [3] local</span></span>
<span><span class="co">#&gt;  vctrs         0.6.5   2023-12-01 [1] RSPM</span></span>
<span><span class="co">#&gt;  withr         3.0.1   2024-07-31 [1] RSPM</span></span>
<span><span class="co">#&gt;  xfun          0.46    2024-07-18 [1] RSPM</span></span>
<span><span class="co">#&gt;  xml2          1.3.6   2023-12-04 [1] RSPM</span></span>
<span><span class="co">#&gt;  yaml          2.3.10  2024-07-26 [1] RSPM</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  [1] /home/runner/work/_temp/Library</span></span>
<span><span class="co">#&gt;  [2] /opt/R/4.4.1/lib/R/site-library</span></span>
<span><span class="co">#&gt;  [3] /opt/R/4.4.1/lib/R/library</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ──────────────────────────────────────────────────────────</span></span></code></pre></div>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="function-factories.html"><span class="header-section-number">10</span> Function factories</a></div>
<div class="next"><a href="base-types.html"><span class="header-section-number">12</span> Base Types</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#function-operators"><span class="header-section-number">11</span> Function operators</a></li>
<li><a class="nav-link" href="#existing-function-operators-exercises-11.2.3"><span class="header-section-number">11.1</span> Existing function operators (Exercises 11.2.3)</a></li>
<li><a class="nav-link" href="#case-study-creating-your-own-function-operators-exercises-11.3.1"><span class="header-section-number">11.2</span> Case study: Creating your own function operators (Exercises 11.3.1)</a></li>
<li><a class="nav-link" href="#session-information-9"><span class="header-section-number">11.3</span> Session information</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/IndrajeetPatil/Advanced-R-exercises/blob/master/Function-operators.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/IndrajeetPatil/Advanced-R-exercises/edit/master/Function-operators.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Advanced R Exercises</strong>" was written by <a class="text-light" href="https://sites.google.com/site/indrajeetspatilmorality/">Indrajeet Patil</a>. It was last built on 2024-08-04.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
