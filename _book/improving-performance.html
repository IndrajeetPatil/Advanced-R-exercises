<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 18 Improving performance | Advanced R Exercises</title>
<meta name="author" content="Indrajeet Patil">
<meta name="description" content="18.0.1 Exercises 24.3.1 Q1. What are faster alternatives to lm()? Which are specifically designed to work with larger datasets? A1. Faster alternatives to lm() can be found by visiting CRAN Task...">
<meta name="generator" content="bookdown 0.25 with bs4_book()">
<meta property="og:title" content="Chapter 18 Improving performance | Advanced R Exercises">
<meta property="og:type" content="book">
<meta property="og:image" content="/cover.png">
<meta property="og:description" content="18.0.1 Exercises 24.3.1 Q1. What are faster alternatives to lm()? Which are specifically designed to work with larger datasets? A1. Faster alternatives to lm() can be found by visiting CRAN Task...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 18 Improving performance | Advanced R Exercises">
<meta name="twitter:description" content="18.0.1 Exercises 24.3.1 Q1. What are faster alternatives to lm()? Which are specifically designed to work with larger datasets? A1. Faster alternatives to lm() can be found by visiting CRAN Task...">
<meta name="twitter:image" content="/cover.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="bs4_style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Advanced R Exercises</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">About</a></li>
<li><a class="" href="introduction.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="names-and-values.html"><span class="header-section-number">2</span> Names and values</a></li>
<li><a class="" href="vectors.html"><span class="header-section-number">3</span> Vectors</a></li>
<li><a class="" href="subsetting.html"><span class="header-section-number">4</span> Subsetting</a></li>
<li><a class="" href="control-flow.html"><span class="header-section-number">5</span> Control flow</a></li>
<li><a class="" href="functions.html"><span class="header-section-number">6</span> Functions</a></li>
<li><a class="" href="environments.html"><span class="header-section-number">7</span> Environments</a></li>
<li><a class="" href="functionals.html"><span class="header-section-number">8</span> Functionals</a></li>
<li><a class="" href="function-factories.html"><span class="header-section-number">9</span> Function factories</a></li>
<li><a class="" href="function-operators.html"><span class="header-section-number">10</span> Function operators</a></li>
<li><a class="" href="base-types.html"><span class="header-section-number">11</span> Base Types</a></li>
<li><a class="" href="s3.html"><span class="header-section-number">12</span> S3</a></li>
<li><a class="" href="r6.html"><span class="header-section-number">13</span> R6</a></li>
<li><a class="" href="trade-offs.html"><span class="header-section-number">14</span> Trade-offs</a></li>
<li><a class="" href="big-picture.html"><span class="header-section-number">15</span> Big Picture</a></li>
<li><a class="" href="debugging.html"><span class="header-section-number">16</span> Debugging</a></li>
<li><a class="" href="measuring-performance.html"><span class="header-section-number">17</span> Measuring performance</a></li>
<li><a class="active" href="improving-performance.html"><span class="header-section-number">18</span> Improving performance</a></li>
<li><a class="" href="rewriting-r-code-in-c.html"><span class="header-section-number">19</span> Rewriting R code in C++</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/IndrajeetPatil/Advanced-R-exercises">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="improving-performance" class="section level1" number="18">
<h1>
<span class="header-section-number">18</span> Improving performance<a class="anchor" aria-label="anchor" href="#improving-performance"><i class="fas fa-link"></i></a>
</h1>
<div id="exercises-24.3.1" class="section level3" number="18.0.1">
<h3>
<span class="header-section-number">18.0.1</span> Exercises 24.3.1<a class="anchor" aria-label="anchor" href="#exercises-24.3.1"><i class="fas fa-link"></i></a>
</h3>
<p><strong>Q1.</strong> What are faster alternatives to <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code>? Which are specifically designed to work with larger datasets?</p>
<p><strong>A1.</strong> Faster alternatives to <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> can be found by visiting <a href="https://cran.r-project.org/web/views/HighPerformanceComputing.html">CRAN Task View: High-Performance and Parallel Computing with R</a> page.</p>
<p>Here are some of the available options:</p>
<ul>
<li><p><code><a href="https://rdrr.io/pkg/speedglm/man/speedlm.html">speedglm::speedlm()</a></code> (for large datasets)</p></li>
<li><p><code><a href="https://rdrr.io/pkg/biglm/man/biglm.html">biglm::biglm()</a></code> (specifically designed for data too large to fit in memory)</p></li>
<li><p><code><a href="https://rdrr.io/pkg/RcppEigen/man/fastLm.html">RcppEigen::fastLm()</a></code> (using the <code>Eigen</code> linear algebra library)</p></li>
</ul>
<p>High performances can be obtained with these packages especially if R is linked against an optimized BLAS, such as ATLAS. You can check this information using <code><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo()</a></code>:</p>
<div class="sourceCode" id="cb219"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sessInfo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">sessInfo</span><span class="op">$</span><span class="va">matprod</span>
<span class="co">#&gt; [1] "default"</span>
<span class="va">sessInfo</span><span class="op">$</span><span class="va">LAPACK</span>
<span class="co">#&gt; [1] "/Library/Frameworks/R.framework/Versions/4.1-arm64/Resources/lib/libRlapack.dylib"</span></code></pre></div>
<p>Comparing performance of different alternatives:</p>
<div class="sourceCode" id="cb220"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jennybc/gapminder">gapminder</a></span><span class="op">)</span>

<span class="co"># having a look at the data</span>
<span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">gapminder</span><span class="op">)</span>
<span class="co">#&gt; Rows: 1,704</span>
<span class="co">#&gt; Columns: 6</span>
<span class="co">#&gt; $ country   &lt;fct&gt; "Afghanistan", "Afghanistan", "Afghanist…</span>
<span class="co">#&gt; $ continent &lt;fct&gt; Asia, Asia, Asia, Asia, Asia, Asia, Asia…</span>
<span class="co">#&gt; $ year      &lt;int&gt; 1952, 1957, 1962, 1967, 1972, 1977, 1982…</span>
<span class="co">#&gt; $ lifeExp   &lt;dbl&gt; 28.801, 30.332, 31.997, 34.020, 36.088, …</span>
<span class="co">#&gt; $ pop       &lt;int&gt; 8425333, 9240934, 10267083, 11537966, 13…</span>
<span class="co">#&gt; $ gdpPercap &lt;dbl&gt; 779.4453, 820.8530, 853.1007, 836.1971, …</span>

<span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html">mark</a></span><span class="op">(</span>
  <span class="st">"lm"</span>       <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">continent</span> <span class="op">*</span> <span class="va">gdpPercap</span>, <span class="va">gapminder</span><span class="op">)</span>,
  <span class="st">"speedglm"</span> <span class="op">=</span> <span class="fu">speedglm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/speedglm/man/speedlm.html">speedlm</a></span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">continent</span> <span class="op">*</span> <span class="va">gdpPercap</span>, <span class="va">gapminder</span><span class="op">)</span>,
  <span class="st">"biglm"</span>    <span class="op">=</span> <span class="fu">biglm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/biglm/man/biglm.html">biglm</a></span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">continent</span> <span class="op">*</span> <span class="va">gdpPercap</span>, <span class="va">gapminder</span><span class="op">)</span>,
  <span class="st">"fastLm"</span>   <span class="op">=</span> <span class="fu">RcppEigen</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RcppEigen/man/fastLm.html">fastLm</a></span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">continent</span> <span class="op">*</span> <span class="va">gdpPercap</span>, <span class="va">gapminder</span><span class="op">)</span>,
  check      <span class="op">=</span> <span class="cn">FALSE</span>,
  iterations <span class="op">=</span> <span class="fl">1000</span>
<span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>
<span class="co">#&gt; # A tibble: 4 × 5</span>
<span class="co">#&gt;   expression      min   median `itr/sec` mem_alloc</span>
<span class="co">#&gt;   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;</span>
<span class="co">#&gt; 1 lm            569µs    603µs     1588.    1.25MB</span>
<span class="co">#&gt; 2 speedglm      586µs    626µs     1566.   61.51MB</span>
<span class="co">#&gt; 3 biglm         466µs    503µs     1970.  934.81KB</span>
<span class="co">#&gt; 4 fastLm        535µs    587µs     1687.  982.41KB</span></code></pre></div>
<p>The results might change depending on the size of the dataset, so you will have to experiment with different algorithms and find the one that fits the needs of your dataset the best.</p>
<p><strong>Q2.</strong> What package implements a version of <code><a href="https://rdrr.io/r/base/match.html">match()</a></code> that’s faster for repeated look ups? How much faster is it?</p>
<p><strong>A2.</strong> The package (and the respective function) is <code><a href="https://rdrr.io/pkg/fastmatch/man/fmatch.html">fastmatch::fmatch()</a></code><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;In addition to Google search, you can also try &lt;a href="https://www.zuckarelli.de/packagefinder/tutorial.html"&gt;packagefinder&lt;/a&gt; to search for CRAN packages.&lt;/p&gt;'><sup>8</sup></a>.</p>
<p>The documentation for this function notes:</p>
<blockquote>
<p>It is slightly faster than the built-in version because it uses more specialized code, but in addition it retains the hash table within the table object such that it can be re-used, dramatically reducing the look-up time especially for large table.</p>
</blockquote>
<p>Let’s try.</p>
<p>With a small vector, <code><a href="https://rdrr.io/pkg/fastmatch/man/fmatch.html">fmatch()</a></code> is only slightly faster, but of the same order of magnitude.</p>
<div class="sourceCode" id="cb221"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.rforge.net/fastmatch">fastmatch</a></span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'fastmatch'</span>
<span class="co">#&gt; The following object is masked from 'package:dplyr':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     coalesce</span>

<span class="va">small_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"x"</span>, <span class="st">"m"</span>, <span class="st">"n"</span>, <span class="st">"y"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">small_vec</span><span class="op">)</span>
<span class="co">#&gt; [1] 6</span>

<span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html">mark</a></span><span class="op">(</span>
  <span class="st">"base"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>, <span class="va">small_vec</span><span class="op">)</span>,
  <span class="st">"fastmatch"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/fastmatch/man/fmatch.html">fmatch</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>, <span class="va">small_vec</span><span class="op">)</span>
<span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>
<span class="co">#&gt; # A tibble: 2 × 5</span>
<span class="co">#&gt;   expression      min   median `itr/sec` mem_alloc</span>
<span class="co">#&gt;   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;</span>
<span class="co">#&gt; 1 base          451ns    533ns  1651310.    2.77KB</span>
<span class="co">#&gt; 2 fastmatch     369ns    451ns  2029792.    2.66KB</span></code></pre></div>
<p>But, with a larger vector, <code><a href="https://rdrr.io/pkg/fastmatch/man/fmatch.html">fmatch()</a></code> is only orders of magnitude faster! ⚡</p>
<div class="sourceCode" id="cb222"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">large_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span>, <span class="fl">1e4</span><span class="op">)</span>, <span class="st">"x"</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"m"</span>, <span class="st">"n"</span><span class="op">)</span>, <span class="fl">1e6</span><span class="op">)</span>, <span class="st">"y"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">large_vec</span><span class="op">)</span>
<span class="co">#&gt; [1] 2020002</span>

<span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html">mark</a></span><span class="op">(</span>
  <span class="st">"base"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>, <span class="va">large_vec</span><span class="op">)</span>,
  <span class="st">"fastmatch"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/fastmatch/man/fmatch.html">fmatch</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>, <span class="va">large_vec</span><span class="op">)</span>
<span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>
<span class="co">#&gt; # A tibble: 2 × 5</span>
<span class="co">#&gt;   expression      min   median `itr/sec` mem_alloc</span>
<span class="co">#&gt;   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;</span>
<span class="co">#&gt; 1 base         14.3ms   14.4ms      68.5    31.4MB</span>
<span class="co">#&gt; 2 fastmatch     369ns    451ns 2052027.         0B</span></code></pre></div>
<p>We can also look at the hash table:</p>
<div class="sourceCode" id="cb223"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/fastmatch/man/fmatch.html">fmatch.hash</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>, <span class="va">small_vec</span><span class="op">)</span>
<span class="co">#&gt; [1] "a" "b" "x" "m" "n" "y"</span>
<span class="co">#&gt; attr(,".match.hash")</span>
<span class="co">#&gt; &lt;hash table&gt;</span></code></pre></div>
<p>Additionally, <a href="http://www.rforge.net/fastmatch">fastmatch</a> also provides a similar infix operator:</p>
<div class="sourceCode" id="cb224"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.rforge.net/fastmatch">fastmatch</a></span><span class="op">)</span>

<span class="va">small_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"x"</span>, <span class="st">"m"</span>, <span class="st">"n"</span>, <span class="st">"y"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">small_vec</span>
<span class="co">#&gt; [1] TRUE TRUE</span>

<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/fastmatch/man/fmatch.html">%fin%</a></span> <span class="va">small_vec</span>
<span class="co">#&gt; [1] TRUE TRUE</span></code></pre></div>
<p><strong>Q3.</strong> List four functions (not just those in base R) that convert a string into a date time object. What are their strengths and weaknesses?</p>
<p><strong>Q4.</strong> Which packages provide the ability to compute a rolling mean?</p>
<p><strong>A4.</strong> Here are a few packages and respective functions that provide a way to compute a rolling mean:</p>
<ul>
<li><code><a href="https://rdrr.io/pkg/RcppRoll/man/RcppRoll-exports.html">RcppRoll::roll_mean()</a></code></li>
<li><code><a href="https://Rdatatable.gitlab.io/data.table/reference/froll.html">data.table::frollmean()</a></code></li>
<li><code><a href="https://rdrr.io/pkg/roll/man/roll_mean.html">roll::roll_mean()</a></code></li>
<li><code><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">zoo::rollmean()</a></code></li>
<li><code><a href="https://rdrr.io/pkg/slider/man/slide.html">slider::slide_dbl()</a></code></li>
</ul>
<p><strong>Q5.</strong> What are the alternatives to <code><a href="https://rdrr.io/r/stats/optim.html">optim()</a></code>?</p>
</div>
<div id="exercises-24.4.3" class="section level3" number="18.0.2">
<h3>
<span class="header-section-number">18.0.2</span> Exercises 24.4.3<a class="anchor" aria-label="anchor" href="#exercises-24.4.3"><i class="fas fa-link"></i></a>
</h3>
<p><strong>Q1.</strong> What’s the difference between <code><a href="https://rdrr.io/r/base/colSums.html">rowSums()</a></code> and <code><a href="https://rdrr.io/r/base/colSums.html">.rowSums()</a></code>?</p>
<p><strong>A1.</strong> The documentation for these functions state:</p>
<blockquote>
<p>The versions with an initial dot in the name (.colSums() etc) are ‘bare-bones’ versions for use in programming: they apply only to numeric (like) matrices and do not name the result.</p>
</blockquote>
<p>Looking at the source code,</p>
<ul>
<li>
<code><a href="https://rdrr.io/r/base/colSums.html">rowSums()</a></code> function does a number of checks to validate if the arguments are acceptable</li>
</ul>
<div class="sourceCode" id="cb225"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rowSums</span>
<span class="co">#&gt; function (x, na.rm = FALSE, dims = 1L) </span>
<span class="co">#&gt; {</span>
<span class="co">#&gt;     if (is.data.frame(x)) </span>
<span class="co">#&gt;         x &lt;- as.matrix(x)</span>
<span class="co">#&gt;     if (!is.array(x) || length(dn &lt;- dim(x)) &lt; 2L) </span>
<span class="co">#&gt;         stop("'x' must be an array of at least two dimensions")</span>
<span class="co">#&gt;     if (dims &lt; 1L || dims &gt; length(dn) - 1L) </span>
<span class="co">#&gt;         stop("invalid 'dims'")</span>
<span class="co">#&gt;     p &lt;- prod(dn[-(id &lt;- seq_len(dims))])</span>
<span class="co">#&gt;     dn &lt;- dn[id]</span>
<span class="co">#&gt;     z &lt;- if (is.complex(x)) </span>
<span class="co">#&gt;         .Internal(rowSums(Re(x), prod(dn), p, na.rm)) + (0+1i) * </span>
<span class="co">#&gt;             .Internal(rowSums(Im(x), prod(dn), p, na.rm))</span>
<span class="co">#&gt;     else .Internal(rowSums(x, prod(dn), p, na.rm))</span>
<span class="co">#&gt;     if (length(dn) &gt; 1L) {</span>
<span class="co">#&gt;         dim(z) &lt;- dn</span>
<span class="co">#&gt;         dimnames(z) &lt;- dimnames(x)[id]</span>
<span class="co">#&gt;     }</span>
<span class="co">#&gt;     else names(z) &lt;- dimnames(x)[[1L]]</span>
<span class="co">#&gt;     z</span>
<span class="co">#&gt; }</span>
<span class="co">#&gt; &lt;bytecode: 0x114d54fd8&gt;</span>
<span class="co">#&gt; &lt;environment: namespace:base&gt;</span></code></pre></div>
<ul>
<li>
<code><a href="https://rdrr.io/r/base/colSums.html">.rowSums()</a></code> directly proceeds to computation using an internal code which is built in to the R interpreter</li>
</ul>
<div class="sourceCode" id="cb226"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">.rowSums</span>
<span class="co">#&gt; function (x, m, n, na.rm = FALSE) </span>
<span class="co">#&gt; .Internal(rowSums(x, m, n, na.rm))</span>
<span class="co">#&gt; &lt;bytecode: 0x1243c87a8&gt;</span>
<span class="co">#&gt; &lt;environment: namespace:base&gt;</span></code></pre></div>
<p>But they have comparable performance:</p>
<div class="sourceCode" id="cb227"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span>x1 <span class="op">=</span> <span class="fl">3</span>, x2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span><span class="op">:</span><span class="fl">1e4</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">1e5</span><span class="op">)</span><span class="op">)</span>

<span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html">mark</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">.rowSums</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>
<span class="co">#&gt; # A tibble: 2 × 5</span>
<span class="co">#&gt;   expression                                 min   median</span>
<span class="co">#&gt;   &lt;bch:expr&gt;                            &lt;bch:tm&gt; &lt;bch:tm&gt;</span>
<span class="co">#&gt; 1 rowSums(x)                              94.6µs    134µs</span>
<span class="co">#&gt; 2 .rowSums(x, dim(x)[[1]], dim(x)[[2]])   93.4µs    133µs</span>
<span class="co">#&gt;   `itr/sec` mem_alloc</span>
<span class="co">#&gt;       &lt;dbl&gt; &lt;bch:byt&gt;</span>
<span class="co">#&gt; 1     6903.     859KB</span>
<span class="co">#&gt; 2     7290.     859KB</span></code></pre></div>
<p><strong>Q2.</strong> Make a faster version of <code><a href="https://rdrr.io/r/stats/chisq.test.html">chisq.test()</a></code> that only computes the chi-square test statistic when the input is two numeric vectors with no missing values. You can try simplifying <code><a href="https://rdrr.io/r/stats/chisq.test.html">chisq.test()</a></code> or by coding from the <a href="http://en.wikipedia.org/wiki/Pearson%27s_chi-squared_test">mathematical definition</a>.</p>
<p><strong>A2.</strong> If the function is supposed to accept only two numeric vectors without missing values, then we can make <code><a href="https://rdrr.io/r/stats/chisq.test.html">chisq.test()</a></code> do less work by removing code corresponding to the following :</p>
<ul>
<li>checks for data frame and matrix inputs</li>
<li>goodness-of-fit test</li>
<li>simulating <em>p</em>-values</li>
<li>checking for missing values</li>
</ul>
<p>This leaves us with a much simpler, bare bones implementation:</p>
<div class="sourceCode" id="cb228"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">my_chisq_test</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nlevels.html">nlevels</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">2L</span><span class="op">)</span> <span class="op">||</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nlevels.html">nlevels</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">2L</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"'x' and 'y' must have at least 2 levels"</span><span class="op">)</span>
  <span class="op">}</span>

  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>

  <span class="kw">if</span> <span class="op">(</span><span class="op">(</span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"at least one entry of 'x' must be positive"</span><span class="op">)</span>
  <span class="op">}</span>

  <span class="va">nr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
  <span class="va">nc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>

  <span class="va">sr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
  <span class="va">sc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
  <span class="va">E</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html">outer</a></span><span class="op">(</span><span class="va">sr</span>, <span class="va">sc</span>, <span class="st">"*"</span><span class="op">)</span> <span class="op">/</span> <span class="va">n</span>
  <span class="va">v</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">r</span>, <span class="va">c</span>, <span class="va">n</span><span class="op">)</span> <span class="va">c</span> <span class="op">*</span> <span class="va">r</span> <span class="op">*</span> <span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="va">r</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="va">c</span><span class="op">)</span> <span class="op">/</span> <span class="va">n</span><span class="op">^</span><span class="fl">3</span>
  <span class="va">V</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html">outer</a></span><span class="op">(</span><span class="va">sr</span>, <span class="va">sc</span>, <span class="va">v</span>, <span class="va">n</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/dimnames.html">dimnames</a></span><span class="op">(</span><span class="va">E</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dimnames.html">dimnames</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>

  <span class="va">STATISTIC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">E</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="va">E</span><span class="op">)</span>
  <span class="va">PARAMETER</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">nr</span> <span class="op">-</span> <span class="fl">1L</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">nc</span> <span class="op">-</span> <span class="fl">1L</span><span class="op">)</span>
  <span class="va">PVAL</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Chisquare.html">pchisq</a></span><span class="op">(</span><span class="va">STATISTIC</span>, <span class="va">PARAMETER</span>, lower.tail <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">STATISTIC</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"X-squared"</span>
  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">PARAMETER</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"df"</span>

  <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
      statistic <span class="op">=</span> <span class="va">STATISTIC</span>,
      parameter <span class="op">=</span> <span class="va">PARAMETER</span>,
      p.value <span class="op">=</span> <span class="va">PVAL</span>,
      method <span class="op">=</span> <span class="st">"Pearson's Chi-squared test"</span>,
      observed <span class="op">=</span> <span class="va">x</span>,
      expected <span class="op">=</span> <span class="va">E</span>,
      residuals <span class="op">=</span> <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">E</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">E</span><span class="op">)</span>,
      stdres <span class="op">=</span> <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">E</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">V</span><span class="op">)</span>
    <span class="op">)</span>,
    class <span class="op">=</span> <span class="st">"htest"</span>
  <span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>And, indeed, this custom function performs much better than its base equivalent:</p>
<div class="sourceCode" id="cb229"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">am</span><span class="op">)</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">cyl</span><span class="op">)</span>

<span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html">mark</a></span><span class="op">(</span>
  <span class="st">"base"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/chisq.test.html">chisq.test</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">n</span><span class="op">)</span><span class="op">$</span><span class="va">statistic</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,
  <span class="st">"custom"</span> <span class="op">=</span> <span class="fu">my_chisq_test</span><span class="op">(</span><span class="va">m</span>, <span class="va">n</span><span class="op">)</span><span class="op">$</span><span class="va">statistic</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
<span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>
<span class="co">#&gt; # A tibble: 2 × 5</span>
<span class="co">#&gt;   expression      min   median `itr/sec` mem_alloc</span>
<span class="co">#&gt;   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;</span>
<span class="co">#&gt; 1 base        158.8µs  164.9µs     5979.     180KB</span>
<span class="co">#&gt; 2 custom       40.3µs   42.3µs    23295.     259KB</span></code></pre></div>
<p><strong>Q3.</strong> Can you make a faster version of <code><a href="https://rdrr.io/r/base/table.html">table()</a></code> for the case of an input of two integer vectors with no missing values? Can you use it to speed up your chi-square test?</p>
</div>
<div id="exercises-24.5.1" class="section level3" number="18.0.3">
<h3>
<span class="header-section-number">18.0.3</span> Exercises 24.5.1<a class="anchor" aria-label="anchor" href="#exercises-24.5.1"><i class="fas fa-link"></i></a>
</h3>
<p><strong>Q1.</strong> The density functions, e.g., <code><a href="https://rdrr.io/r/stats/Normal.html">dnorm()</a></code>, have a common interface. Which arguments are vectorised over? What does <code>rnorm(10, mean = 10:1)</code> do?</p>
<p><strong>Q2.</strong> Compare the speed of <code>apply(x, 1, sum)</code> with <code>rowSums(x)</code> for varying sizes of <code>x</code>.</p>
<p><strong>Q3.</strong> How can you use <code><a href="https://rdrr.io/r/base/crossprod.html">crossprod()</a></code> to compute a weighted sum? How much faster is it than the naive <code>sum(x * w)</code>?</p>

</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="measuring-performance.html"><span class="header-section-number">17</span> Measuring performance</a></div>
<div class="next"><a href="rewriting-r-code-in-c.html"><span class="header-section-number">19</span> Rewriting R code in C++</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav"><li>
<a class="nav-link" href="#improving-performance"><span class="header-section-number">18</span> Improving performance</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#exercises-24.3.1"><span class="header-section-number">18.0.1</span> Exercises 24.3.1</a></li>
<li><a class="nav-link" href="#exercises-24.4.3"><span class="header-section-number">18.0.2</span> Exercises 24.4.3</a></li>
<li><a class="nav-link" href="#exercises-24.5.1"><span class="header-section-number">18.0.3</span> Exercises 24.5.1</a></li>
</ul>
</li></ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/IndrajeetPatil/Advanced-R-exercises/blob/master/Perf-improve.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/IndrajeetPatil/Advanced-R-exercises/edit/master/Perf-improve.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Advanced R Exercises</strong>" was written by Indrajeet Patil. It was last built on 2022-03-24.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
