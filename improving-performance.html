<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 24 Improving performance | Advanced R Exercises</title>
<meta name="author" content="Indrajeet Patil">
<meta name="description" content="Attaching the needed libraries: library(ggplot2) library(dplyr) library(purrr)  24.1 Exercises 24.3.1 Q1. What are faster alternatives to lm()? Which are specifically designed to work with larger...">
<meta name="generator" content="bookdown 0.40 with bs4_book()">
<meta property="og:title" content="Chapter 24 Improving performance | Advanced R Exercises">
<meta property="og:type" content="book">
<meta property="og:url" content="https://bookdown.org/IndrajeetPatil/Advanced-R-exercises/improving-performance.html">
<meta property="og:image" content="https://bookdown.org/IndrajeetPatil/Advanced-R-exercises/cover.png">
<meta property="og:description" content="Attaching the needed libraries: library(ggplot2) library(dplyr) library(purrr)  24.1 Exercises 24.3.1 Q1. What are faster alternatives to lm()? Which are specifically designed to work with larger...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 24 Improving performance | Advanced R Exercises">
<meta name="twitter:description" content="Attaching the needed libraries: library(ggplot2) library(dplyr) library(purrr)  24.1 Exercises 24.3.1 Q1. What are faster alternatives to lm()? Which are specifically designed to work with larger...">
<meta name="twitter:image" content="https://bookdown.org/IndrajeetPatil/Advanced-R-exercises/cover.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><link href="libs/Roboto-0.4.9/font.css" rel="stylesheet">
<link href="libs/JetBrains_Mono-0.4.9/font.css" rel="stylesheet">
<link href="libs/Roboto_Slab-0.4.9/font.css" rel="stylesheet">
<script src="libs/bs3compat-0.8.0/transition.js"></script><script src="libs/bs3compat-0.8.0/tabs.js"></script><script src="libs/bs3compat-0.8.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="bs4_style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Advanced R Exercises</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">About</a></li>
<li><a class="" href="introduction.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="names-and-values.html"><span class="header-section-number">2</span> Names and values</a></li>
<li><a class="" href="vectors.html"><span class="header-section-number">3</span> Vectors</a></li>
<li><a class="" href="subsetting.html"><span class="header-section-number">4</span> Subsetting</a></li>
<li><a class="" href="control-flow.html"><span class="header-section-number">5</span> Control flow</a></li>
<li><a class="" href="functions.html"><span class="header-section-number">6</span> Functions</a></li>
<li><a class="" href="environments.html"><span class="header-section-number">7</span> Environments</a></li>
<li><a class="" href="conditions.html"><span class="header-section-number">8</span> Conditions</a></li>
<li><a class="" href="functionals.html"><span class="header-section-number">9</span> Functionals</a></li>
<li><a class="" href="function-factories.html"><span class="header-section-number">10</span> Function factories</a></li>
<li><a class="" href="function-operators.html"><span class="header-section-number">11</span> Function operators</a></li>
<li><a class="" href="base-types.html"><span class="header-section-number">12</span> Base Types</a></li>
<li><a class="" href="s3.html"><span class="header-section-number">13</span> S3</a></li>
<li><a class="" href="r6.html"><span class="header-section-number">14</span> R6</a></li>
<li><a class="" href="s4.html"><span class="header-section-number">15</span> S4</a></li>
<li><a class="" href="trade-offs.html"><span class="header-section-number">16</span> Trade-offs</a></li>
<li><a class="" href="big-picture.html"><span class="header-section-number">17</span> Big Picture</a></li>
<li><a class="" href="expressions.html"><span class="header-section-number">18</span> Expressions</a></li>
<li><a class="" href="quasiquotation.html"><span class="header-section-number">19</span> Quasiquotation</a></li>
<li><a class="" href="evaluation.html"><span class="header-section-number">20</span> Evaluation</a></li>
<li><a class="" href="translation.html"><span class="header-section-number">21</span> Translation</a></li>
<li><a class="" href="debugging.html"><span class="header-section-number">22</span> Debugging</a></li>
<li><a class="" href="measuring-performance.html"><span class="header-section-number">23</span> Measuring performance</a></li>
<li><a class="active" href="improving-performance.html"><span class="header-section-number">24</span> Improving performance</a></li>
<li><a class="" href="rewriting-r-code-in-c.html"><span class="header-section-number">25</span> Rewriting R code in C++</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/IndrajeetPatil/Advanced-R-exercises">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="improving-performance" class="section level1" number="24">
<h1>
<span class="header-section-number">24</span> Improving performance<a class="anchor" aria-label="anchor" href="#improving-performance"><i class="fas fa-link"></i></a>
</h1>
<p>Attaching the needed libraries:</p>
<div class="sourceCode" id="cb647"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/">purrr</a></span><span class="op">)</span></span></code></pre></div>
<div id="exercises-24.3.1" class="section level2" number="24.1">
<h2>
<span class="header-section-number">24.1</span> Exercises 24.3.1<a class="anchor" aria-label="anchor" href="#exercises-24.3.1"><i class="fas fa-link"></i></a>
</h2>
<p><strong>Q1.</strong> What are faster alternatives to <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code>? Which are specifically designed to work with larger datasets?</p>
<p><strong>A1.</strong> Faster alternatives to <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> can be found by visiting <a href="https://cran.r-project.org/web/views/HighPerformanceComputing.html">CRAN Task View: High-Performance and Parallel Computing with R</a> page.</p>
<p>Here are some of the available options:</p>
<ul>
<li><p><code><a href="https://rdrr.io/pkg/speedglm/man/speedlm.html">speedglm::speedlm()</a></code> (for large datasets)</p></li>
<li><p><code><a href="https://rdrr.io/pkg/biglm/man/biglm.html">biglm::biglm()</a></code> (specifically designed for data too large to fit in memory)</p></li>
<li><p><code><a href="https://rdrr.io/pkg/RcppEigen/man/fastLm.html">RcppEigen::fastLm()</a></code> (using the <code>Eigen</code> linear algebra library)</p></li>
</ul>
<p>High performances can be obtained with these packages especially if R is linked against an optimized BLAS, such as ATLAS. You can check this information using <code><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo()</a></code>:</p>
<div class="sourceCode" id="cb648"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sessInfo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">sessInfo</span><span class="op">$</span><span class="va">matprod</span></span>
<span><span class="co">#&gt; [1] "default"</span></span>
<span><span class="va">sessInfo</span><span class="op">$</span><span class="va">LAPACK</span></span>
<span><span class="co">#&gt; [1] "/usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.20.so"</span></span></code></pre></div>
<p>Comparing performance of different alternatives:</p>
<div class="sourceCode" id="cb649"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jennybc/gapminder">gapminder</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># having a look at the data</span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">gapminder</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 1,704</span></span>
<span><span class="co">#&gt; Columns: 6</span></span>
<span><span class="co">#&gt; $ country   &lt;fct&gt; "Afghanistan", "Afghanistan", "Afghanist…</span></span>
<span><span class="co">#&gt; $ continent &lt;fct&gt; Asia, Asia, Asia, Asia, Asia, Asia, Asia…</span></span>
<span><span class="co">#&gt; $ year      &lt;int&gt; 1952, 1957, 1962, 1967, 1972, 1977, 1982…</span></span>
<span><span class="co">#&gt; $ lifeExp   &lt;dbl&gt; 28.801, 30.332, 31.997, 34.020, 36.088, …</span></span>
<span><span class="co">#&gt; $ pop       &lt;int&gt; 8425333, 9240934, 10267083, 11537966, 13…</span></span>
<span><span class="co">#&gt; $ gdpPercap &lt;dbl&gt; 779.4453, 820.8530, 853.1007, 836.1971, …</span></span>
<span></span>
<span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html">mark</a></span><span class="op">(</span></span>
<span>  <span class="st">"lm"</span>       <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">continent</span> <span class="op">*</span> <span class="va">gdpPercap</span>, <span class="va">gapminder</span><span class="op">)</span>,</span>
<span>  <span class="st">"speedglm"</span> <span class="op">=</span> <span class="fu">speedglm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/speedglm/man/speedlm.html">speedlm</a></span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">continent</span> <span class="op">*</span> <span class="va">gdpPercap</span>, <span class="va">gapminder</span><span class="op">)</span>,</span>
<span>  <span class="st">"biglm"</span>    <span class="op">=</span> <span class="fu">biglm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/biglm/man/biglm.html">biglm</a></span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">continent</span> <span class="op">*</span> <span class="va">gdpPercap</span>, <span class="va">gapminder</span><span class="op">)</span>,</span>
<span>  <span class="st">"fastLm"</span>   <span class="op">=</span> <span class="fu">RcppEigen</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RcppEigen/man/fastLm.html">fastLm</a></span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">continent</span> <span class="op">*</span> <span class="va">gdpPercap</span>, <span class="va">gapminder</span><span class="op">)</span>,</span>
<span>  check      <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  iterations <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="co">#&gt; # A tibble: 4 × 5</span></span>
<span><span class="co">#&gt;   expression      min   median `itr/sec` mem_alloc</span></span>
<span><span class="co">#&gt;   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;</span></span>
<span><span class="co">#&gt; 1 lm          845.4µs 893.96µs     1043.    1.26MB</span></span>
<span><span class="co">#&gt; 2 speedglm     1.52ms   1.56ms      641.   70.75MB</span></span>
<span><span class="co">#&gt; 3 biglm       742.5µs 768.49µs     1246.  589.44KB</span></span>
<span><span class="co">#&gt; 4 fastLm       1.01ms   1.04ms      940.    4.54MB</span></span></code></pre></div>
<p>The results might change depending on the size of the dataset, with the performance benefits accruing bigger the dataset.</p>
<p>You will have to experiment with different algorithms and find the one that fits the needs of your dataset the best.</p>
<p><strong>Q2.</strong> What package implements a version of <code><a href="https://rdrr.io/r/base/match.html">match()</a></code> that’s faster for repeated look ups? How much faster is it?</p>
<p><strong>A2.</strong> The package (and the respective function) is <code><a href="https://rdrr.io/pkg/fastmatch/man/fmatch.html">fastmatch::fmatch()</a></code><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;In addition to Google search, you can also try &lt;a href="https://www.zuckarelli.de/packagefinder/tutorial.html"&gt;packagefinder&lt;/a&gt; to search for CRAN packages.&lt;/p&gt;'><sup>7</sup></a>.</p>
<p>The documentation for this function notes:</p>
<blockquote>
<p>It is slightly faster than the built-in version because it uses more specialized code, but in addition it retains the hash table within the table object such that it can be re-used, dramatically reducing the look-up time especially for large table.</p>
</blockquote>
<p>With a small vector, <code><a href="https://rdrr.io/pkg/fastmatch/man/fmatch.html">fmatch()</a></code> is only slightly faster, but of the same order of magnitude.</p>
<div class="sourceCode" id="cb650"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.rforge.net/fastmatch">fastmatch</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">small_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"x"</span>, <span class="st">"m"</span>, <span class="st">"n"</span>, <span class="st">"y"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">small_vec</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 6</span></span>
<span></span>
<span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html">mark</a></span><span class="op">(</span></span>
<span>  <span class="st">"base"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>, <span class="va">small_vec</span><span class="op">)</span>,</span>
<span>  <span class="st">"fastmatch"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/fastmatch/man/fmatch.html">fmatch</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>, <span class="va">small_vec</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 5</span></span>
<span><span class="co">#&gt;   expression      min   median `itr/sec` mem_alloc</span></span>
<span><span class="co">#&gt;   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;</span></span>
<span><span class="co">#&gt; 1 base         1.15µs   1.22µs   750042.     2.8KB</span></span>
<span><span class="co">#&gt; 2 fastmatch    1.07µs   1.11µs   866550.    2.66KB</span></span></code></pre></div>
<p>But, with a larger vector, <code><a href="https://rdrr.io/pkg/fastmatch/man/fmatch.html">fmatch()</a></code> is orders of magnitude faster! ⚡</p>
<div class="sourceCode" id="cb651"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">large_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span>, <span class="fl">1e4</span><span class="op">)</span>, <span class="st">"x"</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"m"</span>, <span class="st">"n"</span><span class="op">)</span>, <span class="fl">1e6</span><span class="op">)</span>, <span class="st">"y"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">large_vec</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2020002</span></span>
<span></span>
<span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html">mark</a></span><span class="op">(</span></span>
<span>  <span class="st">"base"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>, <span class="va">large_vec</span><span class="op">)</span>,</span>
<span>  <span class="st">"fastmatch"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/fastmatch/man/fmatch.html">fmatch</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>, <span class="va">large_vec</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="co">#&gt; Warning: Some expressions had a GC in every iteration; so</span></span>
<span><span class="co">#&gt; filtering is disabled.</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 5</span></span>
<span><span class="co">#&gt;   expression      min   median `itr/sec` mem_alloc</span></span>
<span><span class="co">#&gt;   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;</span></span>
<span><span class="co">#&gt; 1 base        23.58ms   25.5ms      29.0    31.4MB</span></span>
<span><span class="co">#&gt; 2 fastmatch    1.05µs    1.1µs  860395.         0B</span></span></code></pre></div>
<p>We can also look at the hash table:</p>
<div class="sourceCode" id="cb652"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/fastmatch/man/fmatch.html">fmatch.hash</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>, <span class="va">small_vec</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "a" "b" "x" "m" "n" "y"</span></span>
<span><span class="co">#&gt; attr(,".match.hash")</span></span>
<span><span class="co">#&gt; &lt;hash table&gt;</span></span></code></pre></div>
<p>Additionally, <a href="http://www.rforge.net/fastmatch">fastmatch</a> provides equivalent of the familiar infix operator:</p>
<div class="sourceCode" id="cb653"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.rforge.net/fastmatch">fastmatch</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">small_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"x"</span>, <span class="st">"m"</span>, <span class="st">"n"</span>, <span class="st">"y"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">small_vec</span></span>
<span><span class="co">#&gt; [1] TRUE TRUE</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/fastmatch/man/fmatch.html">%fin%</a></span> <span class="va">small_vec</span></span>
<span><span class="co">#&gt; [1] TRUE TRUE</span></span></code></pre></div>
<p><strong>Q3.</strong> List four functions (not just those in base R) that convert a string into a date time object. What are their strengths and weaknesses?</p>
<p><strong>A3.</strong> Here are four functions that convert a string into a date time object:</p>
<ul>
<li><code><a href="https://rdrr.io/r/base/as.POSIXlt.html">base::as.POSIXct()</a></code></li>
</ul>
<div class="sourceCode" id="cb654"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2022-05-05 09:23:22"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2022-05-05 09:23:22 UTC"</span></span></code></pre></div>
<ul>
<li><code><a href="https://rdrr.io/r/base/as.POSIXlt.html">base::as.POSIXlt()</a></code></li>
</ul>
<div class="sourceCode" id="cb655"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXlt</a></span><span class="op">(</span><span class="st">"2022-05-05 09:23:22"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2022-05-05 09:23:22 UTC"</span></span></code></pre></div>
<ul>
<li><code><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html">lubridate::ymd_hms()</a></code></li>
</ul>
<div class="sourceCode" id="cb656"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html">ymd_hms</a></span><span class="op">(</span><span class="st">"2022-05-05-09-23-22"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2022-05-05 09:23:22 UTC"</span></span></code></pre></div>
<ul>
<li><code><a href="https://rdrr.io/pkg/fasttime/man/fastPOSIXct.html">fasttime::fastPOSIXct()</a></code></li>
</ul>
<div class="sourceCode" id="cb657"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">fasttime</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/fasttime/man/fastPOSIXct.html">fastPOSIXct</a></span><span class="op">(</span><span class="st">"2022-05-05 09:23:22"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2022-05-05 09:23:22 UTC"</span></span></code></pre></div>
<p>We can also compare their performance:</p>
<div class="sourceCode" id="cb658"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html">mark</a></span><span class="op">(</span></span>
<span>  <span class="st">"as.POSIXct"</span> <span class="op">=</span> <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2022-05-05 09:23:22"</span><span class="op">)</span>,</span>
<span>  <span class="st">"as.POSIXlt"</span> <span class="op">=</span> <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXlt</a></span><span class="op">(</span><span class="st">"2022-05-05 09:23:22"</span><span class="op">)</span>,</span>
<span>  <span class="st">"ymd_hms"</span> <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html">ymd_hms</a></span><span class="op">(</span><span class="st">"2022-05-05-09-23-22"</span><span class="op">)</span>,</span>
<span>  <span class="st">"fastPOSIXct"</span> <span class="op">=</span> <span class="fu">fasttime</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/fasttime/man/fastPOSIXct.html">fastPOSIXct</a></span><span class="op">(</span><span class="st">"2022-05-05 09:23:22"</span><span class="op">)</span>,</span>
<span>  check <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  iterations <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 4 × 6</span></span>
<span><span class="co">#&gt;   expression       min   median `itr/sec` mem_alloc `gc/sec`</span></span>
<span><span class="co">#&gt;   &lt;bch:expr&gt;  &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 as.POSIXct   28.66µs  36.19µs    27815.        0B    27.8 </span></span>
<span><span class="co">#&gt; 2 as.POSIXlt   19.54µs  20.55µs    48040.        0B     0   </span></span>
<span><span class="co">#&gt; 3 ymd_hms       2.16ms   2.23ms      448.    21.5KB     4.07</span></span>
<span><span class="co">#&gt; 4 fastPOSIXct   1.22µs   1.33µs   727780.        0B     0</span></span></code></pre></div>
<p>There are many more packages that implement a way to convert from string to a date time object. For more, see <a href="https://cran.r-project.org/web/views/TimeSeries.html">CRAN Task View: Time Series Analysis</a></p>
<p><strong>Q4.</strong> Which packages provide the ability to compute a rolling mean?</p>
<p><strong>A4.</strong> Here are a few packages and respective functions that provide a way to compute a rolling mean:</p>
<ul>
<li><code>RcppRoll::roll_mean()</code></li>
<li><code><a href="https://rdatatable.gitlab.io/data.table/reference/froll.html">data.table::frollmean()</a></code></li>
<li><code>roll::roll_mean()</code></li>
<li><code>zoo::rollmean()</code></li>
<li><code>slider::slide_dbl()</code></li>
</ul>
<p><strong>Q5.</strong> What are the alternatives to <code><a href="https://rdrr.io/r/stats/optim.html">optim()</a></code>?</p>
<p><strong>A5.</strong> The <code><a href="https://rdrr.io/r/stats/optim.html">optim()</a></code> function provides general-purpose optimization. As noted in its docs:</p>
<blockquote>
<p>General-purpose optimization based on Nelder–Mead, quasi-Newton and conjugate-gradient algorithms. It includes an option for box-constrained optimization and simulated annealing.</p>
</blockquote>
<p>There are many alternatives and the exact one you would want to choose would depend on the type of optimization you would like to do.</p>
<p>Most available options can be seen at <a href="https://cran.r-project.org/web/views/Optimization.html">CRAN Task View: Optimization and Mathematical Programming</a>.</p>
</div>
<div id="exercises-24.4.3" class="section level2" number="24.2">
<h2>
<span class="header-section-number">24.2</span> Exercises 24.4.3<a class="anchor" aria-label="anchor" href="#exercises-24.4.3"><i class="fas fa-link"></i></a>
</h2>
<p><strong>Q1.</strong> What’s the difference between <code><a href="https://rdrr.io/r/base/colSums.html">rowSums()</a></code> and <code><a href="https://rdrr.io/r/base/colSums.html">.rowSums()</a></code>?</p>
<p><strong>A1.</strong> The documentation for these functions state:</p>
<blockquote>
<p>The versions with an initial dot in the name (.colSums() etc) are ‘bare-bones’ versions for use in programming: they apply only to numeric (like) matrices and do not name the result.</p>
</blockquote>
<p>Looking at the source code,</p>
<ul>
<li>
<code><a href="https://rdrr.io/r/base/colSums.html">rowSums()</a></code> function does a number of checks to validate if the arguments are acceptable</li>
</ul>
<div class="sourceCode" id="cb659"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rowSums</span></span>
<span><span class="co">#&gt; function (x, na.rm = FALSE, dims = 1L) </span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;     if (is.data.frame(x)) </span></span>
<span><span class="co">#&gt;         x &lt;- as.matrix(x)</span></span>
<span><span class="co">#&gt;     if (!is.array(x) || length(dn &lt;- dim(x)) &lt; 2L) </span></span>
<span><span class="co">#&gt;         stop("'x' must be an array of at least two dimensions")</span></span>
<span><span class="co">#&gt;     if (dims &lt; 1L || dims &gt; length(dn) - 1L) </span></span>
<span><span class="co">#&gt;         stop("invalid 'dims'")</span></span>
<span><span class="co">#&gt;     p &lt;- prod(dn[-(id &lt;- seq_len(dims))])</span></span>
<span><span class="co">#&gt;     dn &lt;- dn[id]</span></span>
<span><span class="co">#&gt;     z &lt;- if (is.complex(x)) </span></span>
<span><span class="co">#&gt;         .Internal(rowSums(Re(x), prod(dn), p, na.rm)) + (0+1i) * </span></span>
<span><span class="co">#&gt;             .Internal(rowSums(Im(x), prod(dn), p, na.rm))</span></span>
<span><span class="co">#&gt;     else .Internal(rowSums(x, prod(dn), p, na.rm))</span></span>
<span><span class="co">#&gt;     if (length(dn) &gt; 1L) {</span></span>
<span><span class="co">#&gt;         dim(z) &lt;- dn</span></span>
<span><span class="co">#&gt;         dimnames(z) &lt;- dimnames(x)[id]</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt;     else names(z) &lt;- dimnames(x)[[1L]]</span></span>
<span><span class="co">#&gt;     z</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; &lt;bytecode: 0x5555a2c4c540&gt;</span></span>
<span><span class="co">#&gt; &lt;environment: namespace:base&gt;</span></span></code></pre></div>
<ul>
<li>
<code><a href="https://rdrr.io/r/base/colSums.html">.rowSums()</a></code> directly proceeds to computation using an internal code which is built in to the R interpreter</li>
</ul>
<div class="sourceCode" id="cb660"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">.rowSums</span></span>
<span><span class="co">#&gt; function (x, m, n, na.rm = FALSE) </span></span>
<span><span class="co">#&gt; .Internal(rowSums(x, m, n, na.rm))</span></span>
<span><span class="co">#&gt; &lt;bytecode: 0x5555a3972f08&gt;</span></span>
<span><span class="co">#&gt; &lt;environment: namespace:base&gt;</span></span></code></pre></div>
<p>But they have comparable performance:</p>
<div class="sourceCode" id="cb661"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span>x1 <span class="op">=</span> <span class="fl">3</span>, x2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span><span class="op">:</span><span class="fl">1e4</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">1e5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html">mark</a></span><span class="op">(</span></span>
<span>  <span class="st">"rowSums"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,</span>
<span>  <span class="st">".rowSums"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">.rowSums</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 5</span></span>
<span><span class="co">#&gt;   expression      min   median `itr/sec` mem_alloc</span></span>
<span><span class="co">#&gt;   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;</span></span>
<span><span class="co">#&gt; 1 rowSums       820µs    860µs     1113.     859KB</span></span>
<span><span class="co">#&gt; 2 .rowSums      818µs    857µs     1168.     859KB</span></span></code></pre></div>
<p><strong>Q2.</strong> Make a faster version of <code><a href="https://rdrr.io/r/stats/chisq.test.html">chisq.test()</a></code> that only computes the chi-square test statistic when the input is two numeric vectors with no missing values. You can try simplifying <code><a href="https://rdrr.io/r/stats/chisq.test.html">chisq.test()</a></code> or by coding from the <a href="http://en.wikipedia.org/wiki/Pearson%27s_chi-squared_test">mathematical definition</a>.</p>
<p><strong>A2.</strong> If the function is supposed to accept only two numeric vectors without missing values, then we can make <code><a href="https://rdrr.io/r/stats/chisq.test.html">chisq.test()</a></code> do less work by removing code corresponding to the following :</p>
<ul>
<li>checks for data frame and matrix inputs</li>
<li>goodness-of-fit test</li>
<li>simulating <em>p</em>-values</li>
<li>checking for missing values</li>
</ul>
<p>This leaves us with a much simpler, bare bones implementation:</p>
<div class="sourceCode" id="cb662"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_chisq_test</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">nr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">nc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">sr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">sc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">E</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html">outer</a></span><span class="op">(</span><span class="va">sr</span>, <span class="va">sc</span>, <span class="st">"*"</span><span class="op">)</span> <span class="op">/</span> <span class="va">n</span></span>
<span>  <span class="va">v</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">r</span>, <span class="va">c</span>, <span class="va">n</span><span class="op">)</span> <span class="va">c</span> <span class="op">*</span> <span class="va">r</span> <span class="op">*</span> <span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="va">r</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="va">c</span><span class="op">)</span> <span class="op">/</span> <span class="va">n</span><span class="op">^</span><span class="fl">3</span></span>
<span>  <span class="va">V</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html">outer</a></span><span class="op">(</span><span class="va">sr</span>, <span class="va">sc</span>, <span class="va">v</span>, <span class="va">n</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/dimnames.html">dimnames</a></span><span class="op">(</span><span class="va">E</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dimnames.html">dimnames</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">STATISTIC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">E</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="va">E</span><span class="op">)</span></span>
<span>  <span class="va">PARAMETER</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">nr</span> <span class="op">-</span> <span class="fl">1L</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">nc</span> <span class="op">-</span> <span class="fl">1L</span><span class="op">)</span></span>
<span>  <span class="va">PVAL</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Chisquare.html">pchisq</a></span><span class="op">(</span><span class="va">STATISTIC</span>, <span class="va">PARAMETER</span>, lower.tail <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">STATISTIC</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"X-squared"</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">PARAMETER</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"df"</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      statistic <span class="op">=</span> <span class="va">STATISTIC</span>,</span>
<span>      parameter <span class="op">=</span> <span class="va">PARAMETER</span>,</span>
<span>      p.value <span class="op">=</span> <span class="va">PVAL</span>,</span>
<span>      method <span class="op">=</span> <span class="st">"Pearson's Chi-squared test"</span>,</span>
<span>      observed <span class="op">=</span> <span class="va">x</span>,</span>
<span>      expected <span class="op">=</span> <span class="va">E</span>,</span>
<span>      residuals <span class="op">=</span> <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">E</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">E</span><span class="op">)</span>,</span>
<span>      stdres <span class="op">=</span> <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">E</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">V</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    class <span class="op">=</span> <span class="st">"htest"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>And, indeed, this custom function performs slightly better<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Deliberately choosing a larger dataset to stress test the new function.&lt;/p&gt;"><sup>8</sup></a> than its base equivalent:</p>
<div class="sourceCode" id="cb663"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="fl">1000</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"b"</span>, <span class="fl">9000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>, <span class="fl">5000</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html">mark</a></span><span class="op">(</span></span>
<span>  <span class="st">"base"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/chisq.test.html">chisq.test</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">n</span><span class="op">)</span><span class="op">$</span><span class="va">statistic</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  <span class="st">"custom"</span> <span class="op">=</span> <span class="fu">my_chisq_test</span><span class="op">(</span><span class="va">m</span>, <span class="va">n</span><span class="op">)</span><span class="op">$</span><span class="va">statistic</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 5</span></span>
<span><span class="co">#&gt;   expression      min   median `itr/sec` mem_alloc</span></span>
<span><span class="co">#&gt;   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;</span></span>
<span><span class="co">#&gt; 1 base          888µs    910µs     1089.    1.57MB</span></span>
<span><span class="co">#&gt; 2 custom        695µs    717µs     1385.     5.3MB</span></span></code></pre></div>
<p><strong>Q3.</strong> Can you make a faster version of <code><a href="https://rdrr.io/r/base/table.html">table()</a></code> for the case of an input of two integer vectors with no missing values? Can you use it to speed up your chi-square test?</p>
<p><strong>A3.</strong> In order to make a leaner version of <code><a href="https://rdrr.io/r/base/table.html">table()</a></code>, we can take a similar approach and trim the unnecessary input checks in light of our new API of accepting just two vectors without missing values. We can remove the following components from the code:</p>
<ul>
<li>extracting data from objects entered in <code>...</code> argument</li>
<li>dealing with missing values</li>
<li>other input validation checks</li>
</ul>
<p>In addition to this removal, we can also use <code><a href="https://rdrr.io/pkg/fastmatch/man/fmatch.html">fastmatch::fmatch()</a></code> instead of <code><a href="https://rdrr.io/r/base/match.html">match()</a></code>:</p>
<div class="sourceCode" id="cb664"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_table</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x_sorted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">y_sorted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">x_length</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x_sorted</span><span class="op">)</span></span>
<span>  <span class="va">y_length</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">y_sorted</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">bin</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">fastmatch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/fastmatch/man/fmatch.html">fmatch</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">x_sorted</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="va">x_length</span> <span class="op">*</span> <span class="fu">fastmatch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/fastmatch/man/fmatch.html">fmatch</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">y_sorted</span><span class="op">)</span> <span class="op">-</span></span>
<span>    <span class="va">x_length</span></span>
<span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tabulate.html">tabulate</a></span><span class="op">(</span><span class="va">bin</span>, <span class="va">x_length</span> <span class="op">*</span> <span class="va">y_length</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span></span>
<span>    <span class="va">y</span>,</span>
<span>    dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">x_length</span>, <span class="va">y_length</span><span class="op">)</span>,</span>
<span>    dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_sorted</span>, y <span class="op">=</span> <span class="va">y_sorted</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"table"</span></span>
<span>  <span class="va">y</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The custom function indeed performs slightly better:</p>
<div class="sourceCode" id="cb665"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="fl">1000</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"b"</span>, <span class="fl">9000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>, <span class="fl">5000</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># `check = FALSE` because the custom function has an additional attribute:</span></span>
<span><span class="co"># ".match.hash"</span></span>
<span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html">mark</a></span><span class="op">(</span></span>
<span>  <span class="st">"base"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>,</span>
<span>  <span class="st">"custom"</span> <span class="op">=</span> <span class="fu">my_table</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>,</span>
<span>  check <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 5</span></span>
<span><span class="co">#&gt;   expression      min   median `itr/sec` mem_alloc</span></span>
<span><span class="co">#&gt;   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;</span></span>
<span><span class="co">#&gt; 1 base          628µs    643µs     1546.     960KB</span></span>
<span><span class="co">#&gt; 2 custom        353µs    358µs     2740.     489KB</span></span></code></pre></div>
<p>We can also use this function in our custom chi-squared test function and see if the performance improves any further:</p>
<div class="sourceCode" id="cb666"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_chisq_test2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">my_table</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">nr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">nc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">sr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">sc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">E</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html">outer</a></span><span class="op">(</span><span class="va">sr</span>, <span class="va">sc</span>, <span class="st">"*"</span><span class="op">)</span> <span class="op">/</span> <span class="va">n</span></span>
<span>  <span class="va">v</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">r</span>, <span class="va">c</span>, <span class="va">n</span><span class="op">)</span> <span class="va">c</span> <span class="op">*</span> <span class="va">r</span> <span class="op">*</span> <span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="va">r</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="va">c</span><span class="op">)</span> <span class="op">/</span> <span class="va">n</span><span class="op">^</span><span class="fl">3</span></span>
<span>  <span class="va">V</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html">outer</a></span><span class="op">(</span><span class="va">sr</span>, <span class="va">sc</span>, <span class="va">v</span>, <span class="va">n</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/dimnames.html">dimnames</a></span><span class="op">(</span><span class="va">E</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dimnames.html">dimnames</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">STATISTIC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">E</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="va">E</span><span class="op">)</span></span>
<span>  <span class="va">PARAMETER</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">nr</span> <span class="op">-</span> <span class="fl">1L</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">nc</span> <span class="op">-</span> <span class="fl">1L</span><span class="op">)</span></span>
<span>  <span class="va">PVAL</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Chisquare.html">pchisq</a></span><span class="op">(</span><span class="va">STATISTIC</span>, <span class="va">PARAMETER</span>, lower.tail <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">STATISTIC</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"X-squared"</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">PARAMETER</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"df"</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      statistic <span class="op">=</span> <span class="va">STATISTIC</span>,</span>
<span>      parameter <span class="op">=</span> <span class="va">PARAMETER</span>,</span>
<span>      p.value <span class="op">=</span> <span class="va">PVAL</span>,</span>
<span>      method <span class="op">=</span> <span class="st">"Pearson's Chi-squared test"</span>,</span>
<span>      observed <span class="op">=</span> <span class="va">x</span>,</span>
<span>      expected <span class="op">=</span> <span class="va">E</span>,</span>
<span>      residuals <span class="op">=</span> <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">E</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">E</span><span class="op">)</span>,</span>
<span>      stdres <span class="op">=</span> <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">E</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">V</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    class <span class="op">=</span> <span class="st">"htest"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>And, indeed, this new version of the custom function performs even better than it previously did:</p>
<div class="sourceCode" id="cb667"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="fl">1000</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"b"</span>, <span class="fl">9000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>, <span class="fl">5000</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html">mark</a></span><span class="op">(</span></span>
<span>  <span class="st">"base"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/chisq.test.html">chisq.test</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">n</span><span class="op">)</span><span class="op">$</span><span class="va">statistic</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  <span class="st">"custom"</span> <span class="op">=</span> <span class="fu">my_chisq_test2</span><span class="op">(</span><span class="va">m</span>, <span class="va">n</span><span class="op">)</span><span class="op">$</span><span class="va">statistic</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 5</span></span>
<span><span class="co">#&gt;   expression      min   median `itr/sec` mem_alloc</span></span>
<span><span class="co">#&gt;   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;</span></span>
<span><span class="co">#&gt; 1 base          892µs    919µs     1081.    1.28MB</span></span>
<span><span class="co">#&gt; 2 custom        416µs    425µs     2316.  593.61KB</span></span></code></pre></div>
</div>
<div id="exercises-24.5.1" class="section level2" number="24.3">
<h2>
<span class="header-section-number">24.3</span> Exercises 24.5.1<a class="anchor" aria-label="anchor" href="#exercises-24.5.1"><i class="fas fa-link"></i></a>
</h2>
<p><strong>Q1.</strong> The density functions, e.g., <code><a href="https://rdrr.io/r/stats/Normal.html">dnorm()</a></code>, have a common interface. Which arguments are vectorised over? What does <code>rnorm(10, mean = 10:1)</code> do?</p>
<p><strong>A1.</strong> The density function family has the following interface:</p>
<div class="sourceCode" id="cb668"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">x</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1</span>, log <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span><span class="op">(</span><span class="va">q</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1</span>, lower.tail <span class="op">=</span> <span class="cn">TRUE</span>, log.p <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">qnorm</a></span><span class="op">(</span><span class="va">p</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1</span>, lower.tail <span class="op">=</span> <span class="cn">TRUE</span>, log.p <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>Reading the documentation reveals that the following parameters are vectorized:
<code>x</code>, <code>q</code>, <code>p</code>, <code>mean</code>, <code>sd</code>.</p>
<p>This means that something like the following will work:</p>
<div class="sourceCode" id="cb669"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>, mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1.124335 0.930398 3.844935</span></span></code></pre></div>
<p>But, for functions that don’t have multiple vectorized parameters, it won’t. For example,</p>
<div class="sourceCode" id="cb670"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>, mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span>, log.p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="cn">TRUE</span>, <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.84134475 0.99865010 0.02275013</span></span></code></pre></div>
<p>The following function call generates 10 random numbers (since <code>n = 10</code>) with 10 different distributions with means supplied by the vector <code>10:1</code>.</p>
<div class="sourceCode" id="cb671"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span>, mean <span class="op">=</span> <span class="fl">10</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1]  8.2421770  9.3920474  7.1362118  7.5789906  5.2551688</span></span>
<span><span class="co">#&gt;  [6]  6.0143714  4.6147891  1.1096247  2.8759129 -0.6756857</span></span></code></pre></div>
<p><strong>Q2.</strong> Compare the speed of <code>apply(x, 1, sum)</code> with <code>rowSums(x)</code> for varying sizes of <code>x</code>.</p>
<p><strong>A2.</strong> We can write a custom function to vary number of rows in a matrix and extract a data frame comparing performance of these two functions.</p>
<div class="sourceCode" id="cb672"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">benc_perform</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">nRow</span>, <span class="va">nCol</span> <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">nRow</span> <span class="op">*</span> <span class="va">nCol</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">nRow</span>, ncol <span class="op">=</span> <span class="va">nCol</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html">mark</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, <span class="va">sum</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">nRowList</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">100</span>, <span class="fl">500</span>, <span class="fl">1000</span>, <span class="fl">5000</span>, <span class="fl">10000</span>, <span class="fl">50000</span>, <span class="fl">100000</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">nRowList</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">nRowList</span><span class="op">)</span></span>
<span></span>
<span><span class="va">benchDF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html">map_dfr</a></span><span class="op">(</span></span>
<span>  .x <span class="op">=</span> <span class="va">nRowList</span>,</span>
<span>  .f <span class="op">=</span> <span class="op">~</span> <span class="fu">benc_perform</span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>,</span>
<span>  .id <span class="op">=</span> <span class="st">"nRows"</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>nRows <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">nRows</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Plotting this data reveals that <code>rowSums(x)</code> has <em>O</em>(1) behavior, while <em>O</em>(n) behavior.</p>
<div class="sourceCode" id="cb673"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span></span>
<span>  <span class="va">benchDF</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">nRows</span><span class="op">)</span>,</span>
<span>    y <span class="op">=</span> <span class="va">median</span>,</span>
<span>    group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">expression</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">expression</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Number of Rows"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Median Execution Time"</span>,</span>
<span>    colour <span class="op">=</span> <span class="st">"Function used"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="Perf-improve_files/figure-html/Perf-improve-28-1.png" width="100%"></div>
<p><strong>Q3.</strong> How can you use <code><a href="https://rdrr.io/r/base/crossprod.html">crossprod()</a></code> to compute a weighted sum? How much faster is it than the naive <code>sum(x * w)</code>?</p>
<p><strong>A3.</strong> Both of these functions provide a way to compute a weighted sum:</p>
<div class="sourceCode" id="cb674"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/crossprod.html">crossprod</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">w</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 15.94691</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span> <span class="op">*</span> <span class="va">w</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 15.94691</span></span></code></pre></div>
<p>But benchmarking their performance reveals that the latter is significantly faster than the former!</p>
<div class="sourceCode" id="cb675"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html">mark</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/crossprod.html">crossprod</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">w</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span> <span class="op">*</span> <span class="va">w</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  iterations <span class="op">=</span> <span class="fl">1e6</span></span>
<span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 5</span></span>
<span><span class="co">#&gt;   expression                min   median `itr/sec` mem_alloc</span></span>
<span><span class="co">#&gt;   &lt;bch:expr&gt;           &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;</span></span>
<span><span class="co">#&gt; 1 crossprod(x, w)[[1]]    411ns    451ns  2082881.        0B</span></span>
<span><span class="co">#&gt; 2 sum(x * w)[[1]]         470ns    511ns  1804038.        0B</span></span></code></pre></div>

</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="measuring-performance.html"><span class="header-section-number">23</span> Measuring performance</a></div>
<div class="next"><a href="rewriting-r-code-in-c.html"><span class="header-section-number">25</span> Rewriting R code in C++</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#improving-performance"><span class="header-section-number">24</span> Improving performance</a></li>
<li><a class="nav-link" href="#exercises-24.3.1"><span class="header-section-number">24.1</span> Exercises 24.3.1</a></li>
<li><a class="nav-link" href="#exercises-24.4.3"><span class="header-section-number">24.2</span> Exercises 24.4.3</a></li>
<li><a class="nav-link" href="#exercises-24.5.1"><span class="header-section-number">24.3</span> Exercises 24.5.1</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/IndrajeetPatil/Advanced-R-exercises/blob/master/Perf-improve.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/IndrajeetPatil/Advanced-R-exercises/edit/master/Perf-improve.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Advanced R Exercises</strong>" was written by <a class="text-light" href="https://sites.google.com/site/indrajeetspatilmorality/">Indrajeet Patil</a>. It was last built on 2024-08-25.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
